<div align="center">

<!-- Logo placeholder - Replace with your actual logo -->
<img src="./assets/logo.png" alt="MenuChi Logo" width="120">

# MenuChi

**No-Code Menu Builder for Restaurants**

*Empowering restaurant owners to create interactive digital menus effortlessly*

[![TypeScript](https://img.shields.io/badge/TypeScript-007ACC?style=for-the-badge&logo=typescript&logoColor=white)](https://typescriptlang.org/)
[![Express.js](https://img.shields.io/badge/Express.js-404D59?style=for-the-badge&logo=express)](https://expressjs.com/)
[![Node.js](https://img.shields.io/badge/Node.js-43853D?style=for-the-badge&logo=node.js&logoColor=white)](https://nodejs.org/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-316192?style=for-the-badge&logo=postgresql&logoColor=white)](https://postgresql.org/)
[![Prisma](https://img.shields.io/badge/Prisma-3982CE?style=for-the-badge&logo=Prisma&logoColor=white)](https://prisma.io/)
[![Redis](https://img.shields.io/badge/Redis-DC382D?style=for-the-badge&logo=redis&logoColor=white)](https://redis.io/)
[![AWS S3](https://img.shields.io/badge/AWS%20S3-FF9900?style=for-the-badge&logo=amazon-s3&logoColor=white)](https://aws.amazon.com/s3/)
[![Docker](https://img.shields.io/badge/Docker-2496ED?style=for-the-badge&logo=docker&logoColor=white)](https://docker.com/)
[![Vitest](https://img.shields.io/badge/Vitest-6E9F18?style=for-the-badge&logo=vitest&logoColor=white)](https://vitest.dev/)
[![TSOA](https://img.shields.io/badge/TSOA-FF6B6B?style=for-the-badge)](https://tsoa-community.github.io/docs/)

[üìö API Documentation](http://localhost:3000/docs) ‚Ä¢ [üîó Database Schema](https://dbdiagram.io/d/menuchi-db-67d2dbb575d75cc844f75bb6)

</div>

## ‚ú® Features

<table>
<tr>
<td width="50%">

### üé® **No-Code Experience**
Create and customize digital menus without any coding expertise

### üîê **Secure Authentication**
Role-based access control with session handling and Redis caching

</td>
<td width="50%">

### ‚òÅÔ∏è **Cloud Storage**
AWS S3 integration for secure image and asset management

### üìñ **Auto Documentation**
Swagger API docs generated automatically with TSOA

</td>
</tr>
</table>

## üîÑ Workflows

MenuChi follows a flexible, hierarchical structure for menu management.

### Two Primary Workflows

1. **Backlog Management**
   - `Restaurant ‚Üí Branch ‚Üí Backlog ‚Üí Categories ‚Üí Items`
   - Create a restaurant, which automatically generates a default branch and its backlog.
   - Within the backlog, create categories and add items to those categories.

2. **Menu Publishing** 
   - `Branch ‚Üí Menu ‚Üí Cylinder ‚Üí MenuCategory ‚Üí Items`
   - Create a menu for a branch.
   - Define cylinders, which represent a combination of days (e.g., specific days or recurring schedules like Monday‚ÄìFriday) to control menu availability.
   - Within each cylinder, select categories from the backlog and include specific items, allowing reuse of categories across different cylinders with unused items.

## üîê Authentication Methods

| User Type | Method | Description |
|-----------|--------|-------------|
| **Restaurant Owner** | Phone Number + Password | Secure login for restaurant management |
| **Customer** | Email OTP | Quick one-time password access for ordering |

## üì¶ Order Management

### Simple & Efficient Order Handling

- **üìù Order Placement**: Customers place orders through interactive menus
- **üìä Status Tracking**: Real-time order status updates (PENDING ‚Üí PREPARING ‚Üí DONE)
- **üîó Item Linking**: Orders connected to specific menu items with quantities and prices
- **üìã Dashboard Management**: Restaurant owners manage orders through intuitive dashboard

## üìÅ Project Structure

```
MenuChi
‚îú‚îÄ‚îÄ üìÇ src
‚îÇ   ‚îú‚îÄ‚îÄ config/              # Configuration files
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ OtpRedisClient.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RedisClient.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SessionConfig.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ swagger.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ TransformersRedisClient.ts
‚îÇ   ‚îú‚îÄ‚îÄ controllers/          # API request handlers
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üîê AuthController.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üìã BacklogController.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üè¢ BranchController.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üì± MenuController.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üì¶ OrderController.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üè™ RestaurantController.ts
‚îÇ   ‚îú‚îÄ‚îÄ db/                  # Database configuration
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ üîß prisma.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ üìã schema.prisma
‚îÇ   ‚îú‚îÄ‚îÄ exceptions/          # Custom error classes
‚îÇ   ‚îú‚îÄ‚îÄ middlewares/         # Express middleware
‚îÇ   ‚îú‚îÄ‚îÄ services/            # Business logic
‚îÇ   ‚îú‚îÄ‚îÄ types/               # TypeScript definitions
‚îÇ   ‚îî‚îÄ‚îÄ utils/               # Utility functions
‚îú‚îÄ‚îÄ test/                    # Unit tests
‚îî‚îÄ‚îÄ Dockerfile               # Container configuration
```

## üåç Environment Setup

Create a `.env` file with the following configuration:

```bash
# üöÄ Server Configuration
PORT=3000
MENUCHI_FRONT_URL=http://localhost:3001

# üóÑÔ∏è Database
DATABASE_URL=postgres://postgres:postgres@localhost:5432/menuchi

# üî¥ Redis Configuration
REDIS_URL=redis://:@localhost:6379
TRANSFORMERS_REDIS_URL=redis://:@localhost:6379/1
OTP_REDIS_URL=redis://:@localhost:32768/5

# üìß External Services
TRANSFORMERS_STREAM=images
OTP_STREAM=otps
INTERNAL_OTP_URL=http://otp-service:3000
INTERNAL_OTP_ENDPOINT=/verify

# ‚òÅÔ∏è AWS S3 Storage
S3_BUCKETNAME=menuchi-bucket
S3_ENDPOINT=https://s3.amazonaws.com
S3_ACCESSKEYID=your-access-key-id
S3_SECRETACCESSKEY=your-secret-access-key
S3_DEFAULT_KEY=default-key

# üîê Security
SESSION_SECRET=your-session-secret
COOKIE_PRIVATE_KEY=your-cookie-private-key
JWT_PRIVATE_KEY=your-jwt-private-key
```

> ‚ö†Ô∏è **Important**: Replace placeholder values with your actual credentials

## üóÑÔ∏è Database Schema

The database schema is defined using Prisma and PostgreSQL. A visual representation is available at [DBDiagram](https://dbdiagram.io/d/menuchi-db-67d2dbb575d75cc844f75bb6). Key models include:

- **User**: Stores user details, authentication data, and relationships to restaurants and roles.
- **Role**: Manages RBAC with roles like ADMIN, RESTAURANT_OWNER, and RESTAURANT_CUSTOMER.
- **Restaurant**: Represents a restaurant with details like name, social media links, and associated branches.
- **Branch**: Represents a restaurant branch with address, opening times, and menus.
- **Menu**: Stores menu details with associated cylinders (scheduling) and orders.
- **CategoryName**: Defines reusable category names for menu items.
- **Category**: Links categories to backlogs and menu categories.
- **Item**: Represents menu items with details like price, ingredients, and position.
- **Cylinder**: Manages menu scheduling (e.g., daily availability).
- **Order**: Tracks customer orders with status and associated items.
- **OrderItem**: Links orders to specific menu items.
- **Address**: Stores branch addresses.
- **OpeningTimes**: Manages branch operating hours.

See `src/db/schema.prisma` for the complete schema.

## ‚ö†Ô∏è Error Handling System

MenuChi implements a sophisticated error handling system with **entity-specific error codes**:

### üè∑Ô∏è Entity Code Mapping

| Entity | Code | Example |
|--------|------|---------|
| üåê General | 0 | `4000` |
| üè™ Restaurant | 1 | `4041` |
| üìÇ CategoryName | 2 | `4042` |
| üçï Item | 3 | `4043` |
| ‚òÅÔ∏è S3 | 4 | `4044` |
| üë§ User | 5 | `4045` |

### üõ°Ô∏è Error Classes

- `MenuchiError` - Base error class
- `AuthError` - Authentication failures
- `DatabaseError` - Database operation errors
- `NotFoundError` - Resource not found
- `ValidationError` - Input validation errors

## üîó External Services

### üñºÔ∏è **Transformers Service**
Image processing and compression via Redis Streams

### üìß **OTP Service**
Email-based one-time password authentication

> üí° Both services are part of the MenuChi ecosystem and communicate via Redis Streams

## üöÄ Setup and Installation

1. **Clone the Repository**:

   ```bash
   git clone https://github.com/menuchi-project/menuchi-app.git
   cd menuchi-app
   ```

2. **Install Dependencies**:

   ```bash
   npm install
   ```

3. **Set Up Environment Variables**:

   - Copy the `.env.example` to `.env` and fill in the required values (see [Environment Variables](#environment-variables)).

4. **Set Up PostgreSQL**:

   - Ensure PostgreSQL is running and create a database named `menuchi`.
   - Update `DATABASE_URL` in the `.env` file.

5. **Set Up Redis**:

   - Ensure Redis is running and update `REDIS_URL`, `TRANSFORMERS_REDIS_URL`, and `OTP_REDIS_URL` in the `.env` file.

6. **Set Up AWS S3**:

   - Configure S3 credentials (`S3_BUCKETNAME`, `S3_ENDPOINT`, `S3_ACCESSKEYID`, `S3_SECRETACCESSKEY`) in the `.env` file.

7. **Run Database Migrations**:

   ```bash
   npx prisma migrate dev
   ```

## Running the Application

1. **Development Mode**:

   ```bash
   npm run dev
   ```

   This generates TSOA routes and Swagger docs before starting the server.

2. **Production Mode**:

   ```bash
   npm run build
   npm start
   ```

3. **Docker**:

   ```bash
   docker build -t menuchi .
   docker run -p 3000:3000 --env-file .env menuchi
   ```

The application will be available at `http://localhost:3000`. Swagger documentation is accessible at `http://localhost:3000/docs`.

## üß™ Testing

MenuChi's testing suite leverages **Vitest** for efficient unit testing, focusing on services and API endpoints. Tests use real **Prisma** queries to validate database interactions without mocking the Prisma client, ensuring accurate query-based logic. Authentication endpoints are tested with **Supertest** to simulate HTTP requests.

### Key Testing Features

- **Real Prisma Queries**: Tests execute actual database queries to verify service logic.
- **Supertest for Auth**: Authentication endpoints (e.g., login, OTP verification) are tested via HTTP requests.
- **Mocked Dependencies**: External services (e.g., S3, Redis) are mocked for isolation.
- **Organized Tests**: Tests are structured by controller in `test/routers`.

### Test Structure

```
test
‚îú‚îÄ‚îÄ routers
‚îÇ   ‚îú‚îÄ‚îÄ Auth.test.ts        # Authentication endpoint tests (Supertest)
‚îÇ   ‚îú‚îÄ‚îÄ Backlog.test.ts     # Backlog functionality tests
‚îÇ   ‚îú‚îÄ‚îÄ Branch.test.ts      # Branch functionality tests
‚îÇ   ‚îú‚îÄ‚îÄ CategoryName.test.ts # Category name tests
‚îÇ   ‚îú‚îÄ‚îÄ Menu.test.ts        # Menu management tests
‚îÇ   ‚îî‚îÄ‚îÄ Restaurant.test.ts  # Restaurant functionality tests
‚îú‚îÄ‚îÄ agents.ts               # Supertest agent setup
‚îú‚îÄ‚îÄ factories.ts           # Test data factories
‚îú‚îÄ‚îÄ vitest.config.ts       # Vitest configuration
‚îî‚îÄ‚îÄ vitest.setup.ts        # Test setup utilities
```

### Running Tests

Configure `.env.test` with test-specific variables (e.g., test database URL) and run:

```bash
npm test
```

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

---

<div align="center">

**Made with ‚ù§Ô∏è by the [MenuChi Team](https://github.com/menuchi-project)**

</div>